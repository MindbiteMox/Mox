@using System.Reflection;
@using Mindbite.Mox.Attributes;
@{
    var modelType = ((object)Model).GetType();
    var formFields = modelType.GetProperties();
    var hiddenFields = new List<System.Reflection.PropertyInfo>();
    var excludedFields = new List<System.Reflection.PropertyInfo>();

    if (typeof(Mindbite.Mox.Core.Models.ISoftDeleted).IsAssignableFrom(modelType))
    {
        var interfaceFields = typeof(Mindbite.Mox.Core.Models.ISoftDeleted).GetProperties().Select(x => x.Name);
        excludedFields.AddRange(formFields.Where(x => interfaceFields.Contains(x.Name)));
    }

    if (typeof(Mindbite.Mox.Core.Models.IUIDEntity).IsAssignableFrom(modelType))
    {
        var interfaceFields = typeof(Mindbite.Mox.Core.Models.IUIDEntity).GetProperties().Select(x => x.Name);
        excludedFields.AddRange(formFields.Where(x => interfaceFields.Contains(x.Name)));
    }

    var hasRenderedFirstField = false;
}

@foreach (var field in formFields)
{
    if (excludedFields.Contains(field))
    {
        continue;
    }

    if (hiddenFields.Contains(field) || field.GetCustomAttributes(typeof(HiddenInputAttribute), true).Any())
    {
        @Html.Hidden(field.Name)
    }
    else if ((field.PropertyType.IsEnum || typeof(IEnumerable<SelectListItem>).IsAssignableFrom(field.PropertyType)) && field.GetCustomAttributes<MoxFormFieldTypeAttribute>().Any())
    {
        var attribute = field.GetCustomAttribute<MoxFormFieldTypeAttribute>();
        var items = default(SelectListItem[]);

        if (field.PropertyType.IsEnum)
        {
            items = Html.GetEnumSelectList(field.PropertyType).ToArray();
        }
        else
        {
            items = ((IEnumerable<SelectListItem>)field.GetValue((object)Model)).ToArray();
        }

        switch (attribute.Render)
        {
            case Render.DropDown:
                <p>
                    @Html.Label(field.Name)
                    @Html.ValidationMessage(field.Name)
                    @Html.DropDownList(field.Name, items, attribute.EmptyLabel)
                </p>
                break;
            case Render.CheckBoxList:
                <ul class="checkbox">
                    @for (int i = 0; i < items.Length; i++)
                    {
                        <li>
                            @Html.Hidden($"{field.Name}[{i}].Value")
                            @Html.Hidden($"{field.Name}[{i}].Text")
                            @Html.CheckBox($"{field.Name}[{i}].Selected")
                            @Html.Label($"{field.Name}[{i}].Selected", items[i].Text)
                        </li>
                    }
                </ul>
                break;
            case Render.Radio:
            default:
                throw new NotImplementedException();
        }
    }
    else
    {
        var renderAttribute = field.GetCustomAttributes<MoxFormFieldTypeAttribute>().FirstOrDefault();

        @if (field.PropertyType == typeof(bool))
        {
            <p class="checkbox">
                @Html.Editor(field.Name)
                @Html.Label(field.Name)
                @Html.ValidationMessage(field.Name)
            </p>
        }
        else
        {
            @if (renderAttribute?.Render == Render.EditorOnly)
            {
                @Html.Editor(field.Name)
            }
            else
            {
                <p>
                    @Html.Label(field.Name)
                    @Html.ValidationMessage(field.Name)

                    @if (!hasRenderedFirstField)
                    {
                        @Html.Editor(field.Name, new { htmlAttributes = new { autofocus = "autofocus" } })
                    }
                    else
                    {
                        @Html.Editor(field.Name)
                    }
                </p>
            }
            hasRenderedFirstField = true;
        }
    }
}